pipeline {
    agent any

    environment {
        // å¯æ ¹æ®éœ€è¦è®¾ç½® Python è·¯å¾„ï¼Œä¸€èˆ¬ç³»ç»Ÿé»˜è®¤ python3 å³å¯
        PYTHON = 'python3'
        PIP = 'pip3'
        GITHUB_TOKEN = credentials('token')
        DB_HOST = '43.163.233.241'
        DB_PORT = '3306'
        DB_CREDS = credentials('database')

        DB_NAME = 'group-11-project'
    }

    stages {
        // =========================
        // 1. æ‹‰å–ä»£ç 
        // =========================
        stage('Checkout') {
            steps {
                echo 'ğŸ”ƒ æ­£åœ¨ä» Git æ‹‰å–ä»£ç ...'
                // å¦‚æœä½ ä½¿ç”¨ Git SCM æ–¹å¼ï¼ŒJenkins ä¼šè‡ªåŠ¨ checkoutï¼Œæ­¤æ­¥å¯çœç•¥
                // ä½†å¦‚æœä½ æƒ³æ˜¾å¼æŒ‡å®šï¼Œä¹Ÿå¯ä»¥ç”¨å¦‚ä¸‹æ–¹å¼ï¼ˆä¸æ¨èé‡å¤ï¼Œé€šå¸¸ç”¨ SCM æ‹‰å–ï¼‰
                git branch: 'main', url: 'https://gitee.com/bigorange074/project_backend_local.git'
            }
        }

        // =========================
        // 2. è®¾ç½® Python è™šæ‹Ÿç¯å¢ƒ
        // =========================
        stage('Setup Virtual Environment') {
            steps {
                echo 'ğŸ æ­£åœ¨è®¾ç½® Python è™šæ‹Ÿç¯å¢ƒ...'
                sh '''
                    # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒç›®å½•
                    python3 -m venv venv
                    # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
                    source venv/bin/activate

                    # å‡çº§ pip
                    pip install --upgrade pip
                '''
            }
        }

        // =========================
        // 3. å®‰è£…ä¾èµ–åŒ…
        // =========================
        stage('Install Dependencies') {
            steps {
                echo 'ğŸ“¦ æ­£åœ¨å®‰è£… Python ä¾èµ–...'
                sh '''
                    source venv/bin/activate
                    pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/
                '''
            }
        }

        // =========================
        
        
        stage('run DB Connection Test') {
            steps {
                sh '''
                    source venv/bin/activate
                    export DB_HOST=${DB_HOST}
                    export DB_NAME=${DB_NAME}
                    export DB_PORT=${DB_PORT}
                    export DB_USER=${DB_CREDS_USR}
                    export DB_PASSWORD=${DB_CREDS_PSW}
                    echo 'æ•°æ®åº“user: ${DB_CREDS_USR}'
                    echo 'æ•°æ®åº“å¯†ç : ${DB_CREDS_PSW}'


                    echo "ğŸ” æ­£åœ¨è¿æ¥æ•°æ®åº“..."
                    python3 src/db_connection.py
                '''
            }
        }
    
        //stage('run LLM Connection Test') {
        //    steps {
        //        sh '''
        //            source venv/bin/activate
        //            export GITHUB_TOKEN=${GITHUB_TOKEN}
        //            
        //            echo "æ­£åœ¨è¿æ¥ GitHub LLM æœåŠ¡..."
        //            python3 src/LLM.py
        //        '''
        //    }
        //}
        // =========================
        // 5. ï¼ˆå¯é€‰ï¼‰è¿è¡Œ Flask åº”ç”¨ï¼ˆå¼€å‘æ¨¡å¼ï¼Œä»…æ¼”ç¤ºï¼‰
        // =========================
        stage('Run Flask App') {
            
            steps {
                echo 'ğŸš€ æ­£åœ¨å¯åŠ¨ Flask å¼€å‘æœåŠ¡å™¨ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼Œå‹¿ç”¨äºç”Ÿäº§ï¼‰...'
                sh '''
                    source venv/bin/activate
                    export FLASK_APP=src/flask_backend.py
                    export FLASK_ENV=development
                    export GITHUB_TOKEN=${GITHUB_TOKEN}
                    export DB_HOST=${DB_HOST}
                    export DB_NAME=${DB_NAME}
                    export DB_PORT=${DB_PORT}
                    export DB_USER=${DB_CREDS_USR}
                    export DB_PASSWORD=${DB_CREDS_PSW}
                    #flask run --host=0.0.0.0 --port=5000
                    gunicorn -w 5 --bind 0.0.0.0:5000 "src.flask_backend:app"
                '''
            }
        }

        // =========================
        // 6. ï¼ˆå¯é€‰ï¼‰æ„å»º Docker é•œåƒ æˆ– éƒ¨ç½²åˆ°æœåŠ¡å™¨
        // =========================
        // ä½ å¯ä»¥åœ¨æ­¤å¤„ç»§ç»­æ‰©å±•ï¼Œæ¯”å¦‚ï¼š
        // - ä½¿ç”¨ Dockerfile æ„å»ºé•œåƒ
        // - æ¨é€é•œåƒåˆ° Registry
        // - é€šè¿‡ SSH éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨
        // è¿™éƒ¨åˆ†æ ¹æ®ä½ çš„éƒ¨ç½²ç›®æ ‡æ¥å®šåˆ¶ï¼Œå¦‚éœ€è¦å¯ç»§ç»­é—®æˆ‘ï¼
    }

   
post {
        success {
            echo 'âœ… CI/CD æµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼'
            
        }

        failure {
            echo 'âŒ CI/CD æµæ°´çº¿æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼'
            
        }

        
        always {
            echo 'ğŸ“‹ æµæ°´çº¿æ‰§è¡Œå®Œæ¯•ï¼ˆæ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼‰'
        }
    }


}