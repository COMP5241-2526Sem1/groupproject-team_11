<!DOCTYPE html>
<html>

<head>
    <title>Set Password - Complete Registration</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- 配置Tailwind自定义样式 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            red: '#C8102E',
                            darkRed: '#A00A23',
                            lightRed: '#F8E0E6'
                        },
                        neutral: {
                            dark: '#333333',
                            medium: '#666666',
                            light: '#F5F5F5'
                        }
                    },
                    fontFamily: {
                        sans: ['Helvetica Neue', 'Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary-red/50 focus:border-primary-red focus:outline-none transition-all;
            }
            .btn-hover {
                @apply hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300;
            }
            .step-active {
                @apply bg-primary-red text-white border-primary-red;
            }
            .step-completed {
                @apply bg-green-500 text-white border-green-500;
            }
            .step-pending {
                @apply bg-white text-neutral-medium border-gray-300;
            }
            .btn-loading {
                @apply opacity-70 cursor-not-allowed hover:translate-y-0 hover:shadow-none;
            }
        }
    </style>
</head>

<body class="bg-neutral-light font-sans text-neutral-dark min-h-screen">
    <!-- 主容器 -->
    <div class="container mx-auto px-4 py-12 md:py-20 flex flex-col items-center justify-center min-h-screen">
        <!-- 进度指示器 -->
        <div class="w-full max-w-md mb-8">
            <div class="flex justify-between items-center">
                <!-- 步骤1：邮箱验证 -->
                <div class="flex flex-col items-center">
                    <div class="w-10 h-10 rounded-full border-2 step-completed flex items-center justify-center mb-2">
                        <i class="fa fa-check"></i>
                    </div>
                    <span class="text-sm font-medium">Email Check</span>
                </div>

                <!-- 连接线1 -->
                <div class="flex-1 h-1 mx-2 bg-gray-300">
                    <div class="h-full w-full bg-primary-red transition-all duration-500"></div>
                </div>

                <!-- 步骤2：验证码 -->
                <div class="flex flex-col items-center">
                    <div class="w-10 h-10 rounded-full border-2 step-completed flex items-center justify-center mb-2">
                        <i class="fa fa-check"></i>
                    </div>
                    <span class="text-sm font-medium">Verification</span>
                </div>

                <!-- 连接线2 -->
                <div class="flex-1 h-1 mx-2 bg-gray-300">
                    <div class="h-full w-full bg-primary-red transition-all duration-500"></div>
                </div>

                <!-- 步骤3：设置密码 -->
                <div class="flex flex-col items-center">
                    <div class="w-10 h-10 rounded-full border-2 step-active flex items-center justify-center mb-2">
                        <i class="fa fa-lock"></i>
                    </div>
                    <span class="text-sm font-medium">Set Password</span>
                </div>
            </div>
        </div>

        <!-- 卡片容器 -->
        <div
            class="w-full max-w-md bg-white rounded-xl shadow-lg overflow-hidden transform transition-all duration-500">
            <!-- 顶部标题栏 -->
            <div class="bg-primary-red py-4 px-6">
                <h1 class="text-[clamp(1.25rem,3vw,1.75rem)] font-bold text-white">Create Password</h1>
                <p class="text-primary-lightRed text-sm mt-1">Set a password to complete your account</p>
            </div>

            <!-- 内容区域 -->
            <div class="p-6 md:p-8">
                <!-- 步骤3：设置密码区域 -->
                <div class="space-y-6">
                    <div>
                        <label for="password" class="block text-sm font-medium text-neutral-dark mb-2">Create
                            Password</label>
                        <input type="password" id="password"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg input-focus"
                            placeholder="At least 8 characters (letters + numbers)" required>
                    </div>

                    <!-- 密码强度要求 -->
                    <div class="bg-neutral-light p-4 rounded-lg">
                        <p class="text-sm font-medium mb-2">Password must contain:</p>
                        <ul class="text-sm space-y-1">
                            <li id="req-length" class="flex items-center text-red-500">
                                <i class="fa fa-times-circle mr-2"></i>
                                <span>At least 8 characters</span>
                            </li>
                            <li id="req-uppercase" class="flex items-center text-red-500">
                                <i class="fa fa-times-circle mr-2"></i>
                                <span>At least one uppercase letter (A-Z)</span>
                            </li>
                            <li id="req-lowercase" class="flex items-center text-red-500">
                                <i class="fa fa-times-circle mr-2"></i>
                                <span>At least one lowercase letter (a-z)</span>
                            </li>
                            <li id="req-number" class="flex items-center text-red-500">
                                <i class="fa fa-times-circle mr-2"></i>
                                <span>At least one number (0-9)</span>
                            </li>
                        </ul>
                    </div>

                    <div>
                        <label for="confirm-password" class="block text-sm font-medium text-neutral-dark mb-2">Confirm
                            Password</label>
                        <input type="password" id="confirm-password"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg input-focus"
                            placeholder="Re-enter your password" required>
                        <p id="password-mismatch" class="text-red-500 text-sm mt-1 hidden">Passwords do not match</p>
                    </div>

                    <!-- 错误提示 -->
                    <p id="network-error" class="text-red-500 text-sm mt-1 hidden">Network error, please check your
                        connection</p>
                    <p id="server-error" class="text-red-500 text-sm mt-1 hidden">Server error, please try again later
                    </p>
                    <p id="password-error" class="text-red-500 text-sm mt-1 hidden">Password does not meet requirements
                    </p>
                    <p id="detailed-error" class="text-orange-500 text-xs mt-1 hidden font-mono"></p>

                    <button id="create-account-btn"
                        class="w-full bg-gray-400 text-white font-medium py-3 px-4 rounded-lg btn-hover cursor-not-allowed"
                        disabled>
                        <span id="btn-text">Create Account</span>
                        <span id="btn-loading" class="hidden"><i
                                class="fa fa-spinner fa-spin mr-2"></i>Creating...</span>
                    </button>

                    <button id="back-to-verification-btn"
                        class="w-full bg-transparent border border-gray-300 text-neutral-dark font-medium py-3 px-4 rounded-lg hover:bg-primary-lightRed hover:border-primary-red/30 transition-colors">
                        Back to Verification
                    </button>
                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <div class="mt-8 text-center text-sm text-neutral-medium">
            <p>© All rights reserved.</p>
            <p class="mt-1">If you have any problems, please contact <a href="mailto:support@example.com"
                    class="text-primary-red hover:underline">support@example.com</a></p>
        </div>
    </div>

    <script>
        // 后端接口配置 - 已更新为新的接口地址
        const API_CONFIG = {
            setPasswordUrl: 'http://43.163.233.241:8081/account/register/email/creatAccount',
            timeout: 15000,
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        };

        // DOM元素
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const createAccountBtn = document.getElementById('create-account-btn');
        const backToVerificationBtn = document.getElementById('back-to-verification-btn');
        const passwordMismatch = document.getElementById('password-mismatch');
        const networkError = document.getElementById('network-error');
        const serverError = document.getElementById('server-error');
        const passwordError = document.getElementById('password-error');
        const detailedError = document.getElementById('detailed-error');
        const btnText = document.getElementById('btn-text');
        const btnLoading = document.getElementById('btn-loading');

        // 密码要求元素
        const reqLength = document.getElementById('req-length');
        const reqUppercase = document.getElementById('req-uppercase');
        const reqLowercase = document.getElementById('req-lowercase');
        const reqNumber = document.getElementById('req-number');

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 检查是否有保存的邮箱和验证码
            const savedEmail = localStorage.getItem('registrationEmail');
            const savedCode = localStorage.getItem('verificationCode');

            if (!savedEmail || !savedCode) {
                // 如果信息不完整，返回上一步
                window.location.href = 'verification.html';
                return;
            }

            // 事件监听
            passwordInput.addEventListener('input', validatePassword);
            confirmPasswordInput.addEventListener('input', validatePassword);
            createAccountBtn.addEventListener('click', createAccount);
            backToVerificationBtn.addEventListener('click', function () {
                window.location.href = 'verification.html';
            });
        });

        /**
         * 验证密码是否符合要求以及两次输入是否一致
         */
        function validatePassword() {
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            let isPasswordValid = true;

            // 验证密码长度
            if (password.length >= 8) {
                reqLength.classList.remove('text-red-500');
                reqLength.classList.add('text-green-500');
                reqLength.innerHTML = '<i class="fa fa-check-circle mr-2"></i><span>At least 8 characters</span>';
            } else {
                reqLength.classList.remove('text-green-500');
                reqLength.classList.add('text-red-500');
                reqLength.innerHTML = '<i class="fa fa-times-circle mr-2"></i><span>At least 8 characters</span>';
                isPasswordValid = false;
            }

            // 验证是否包含大写字母
            if (/[A-Z]/.test(password)) {
                reqUppercase.classList.remove('text-red-500');
                reqUppercase.classList.add('text-green-500');
                reqUppercase.innerHTML = '<i class="fa fa-check-circle mr-2"></i><span>At least one uppercase letter (A-Z)</span>';
            } else {
                reqUppercase.classList.remove('text-green-500');
                reqUppercase.classList.add('text-red-500');
                reqUppercase.innerHTML = '<i class="fa fa-times-circle mr-2"></i><span>At least one uppercase letter (A-Z)</span>';
                isPasswordValid = false;
            }

            // 验证是否包含小写字母
            if (/[a-z]/.test(password)) {
                reqLowercase.classList.remove('text-red-500');
                reqLowercase.classList.add('text-green-500');
                reqLowercase.innerHTML = '<i class="fa fa-check-circle mr-2"></i><span>At least one lowercase letter (a-z)</span>';
            } else {
                reqLowercase.classList.remove('text-green-500');
                reqLowercase.classList.add('text-red-500');
                reqLowercase.innerHTML = '<i class="fa fa-times-circle mr-2"></i><span>At least one lowercase letter (a-z)</span>';
                isPasswordValid = false;
            }

            // 验证是否包含数字
            if (/[0-9]/.test(password)) {
                reqNumber.classList.remove('text-red-500');
                reqNumber.classList.add('text-green-500');
                reqNumber.innerHTML = '<i class="fa fa-check-circle mr-2"></i><span>At least one number (0-9)</span>';
            } else {
                reqNumber.classList.remove('text-green-500');
                reqNumber.classList.add('text-red-500');
                reqNumber.innerHTML = '<i class="fa fa-times-circle mr-2"></i><span>At least one number (0-9)</span>';
                isPasswordValid = false;
            }

            // 验证两次输入是否一致
            let passwordsMatch = false;
            if (password && confirmPassword) {
                if (password === confirmPassword) {
                    passwordMismatch.classList.add('hidden');
                    confirmPasswordInput.classList.remove('border-red-500');
                    confirmPasswordInput.classList.add('border-green-500');
                    passwordsMatch = true;
                } else {
                    passwordMismatch.classList.remove('hidden');
                    confirmPasswordInput.classList.remove('border-green-500');
                    confirmPasswordInput.classList.add('border-red-500');
                    passwordsMatch = false;
                }
            } else {
                passwordMismatch.classList.add('hidden');
                confirmPasswordInput.classList.remove('border-red-500', 'border-green-500');
            }

            // 控制按钮状态
            if (isPasswordValid && passwordsMatch) {
                createAccountBtn.disabled = false;
                createAccountBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                createAccountBtn.classList.add('bg-primary-red', 'hover:bg-primary-darkRed');
            } else {
                createAccountBtn.disabled = true;
                createAccountBtn.classList.remove('bg-primary-red', 'hover:bg-primary-darkRed');
                createAccountBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        /**
         * 创建账户
         */
        async function createAccount() {
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            // 再次验证密码
            if (password !== confirmPassword) {
                passwordMismatch.classList.remove('hidden');
                return;
            }

            // 隐藏所有错误提示
            hideAllErrors();

            // 获取保存的邮箱和验证码
            const savedEmail = localStorage.getItem('registrationEmail');
            const savedCode = localStorage.getItem('verificationCode');

            if (!savedEmail || !savedCode) {
                window.location.href = 'verification.html';
                return;
            }

            // 显示加载状态
            showLoadingState(true);

            try {
                // 使用AbortController实现超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);

                // 调用后端接口设置密码
                const response = await fetch(API_CONFIG.setPasswordUrl, {
                    method: 'POST',
                    headers: API_CONFIG.headers,
                    body: JSON.stringify({
                        email: savedEmail,
                        captcha: savedCode,
                        password: password
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                // 获取响应内容
                const responseText = await response.text();
                console.log('Set Password Response:', responseText);

                // 解析响应
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (jsonError) {
                    console.error('JSON Parse Error:', jsonError);
                    showError('server', 'Invalid response from server');
                    showLoadingState(false);
                    return;
                }

                // 处理响应
                if (!response.ok) {
                    detailedError.textContent = `Error ${response.status}: ${result.msg || 'Failed to set password'}`;
                    detailedError.classList.remove('hidden');

                    if (response.status === 400) {
                        showError('password', result.msg || 'Password does not meet requirements');
                    } else if (response.status >= 500) {
                        showError('server');
                    } else {
                        showError('password', 'Failed to set password. Please try again.');
                    }

                    showLoadingState(false);
                    return;
                }

                // 设置密码成功
                if (result.code === 200) {
                    // 清除本地存储的临时数据
                    localStorage.removeItem('registrationEmail');
                    localStorage.removeItem('verificationCode');

                    // 显示成功提示
                    showToast('Account created successfully! Redirecting to login...', true);

                    // 跳转到登录页面，并添加注册成功的参数
                    setTimeout(() => {
                        window.location.href = 'login.html?registered=true';
                    }, 1500);
                } else {
                    detailedError.textContent = `Code ${result.code}: ${result.msg}`;
                    detailedError.classList.remove('hidden');
                    showError('password', result.msg || 'Failed to set password');
                    showLoadingState(false);
                }
            } catch (error) {
                console.error('Set password error:', error);

                if (error.name === 'AbortError') {
                    showError('server', 'Request timed out');
                } else {
                    showError('network');
                }

                detailedError.textContent = error.message;
                detailedError.classList.remove('hidden');
                showLoadingState(false);
            }
        }

        /**
         * 显示特定类型的错误
         */
        function showError(type, message = null) {
            hideAllErrors();

            if (type === 'password') {
                passwordError.textContent = message || 'Password does not meet requirements';
                passwordError.classList.remove('hidden');
            } else if (type === 'network') {
                networkError.classList.remove('hidden');
            } else if (type === 'server') {
                serverError.textContent = message || 'Server error, please try again later';
                serverError.classList.remove('hidden');
            }
        }

        /**
         * 隐藏所有错误提示
         */
        function hideAllErrors() {
            passwordMismatch.classList.add('hidden');
            networkError.classList.add('hidden');
            serverError.classList.add('hidden');
            passwordError.classList.add('hidden');
            detailedError.classList.add('hidden');
            confirmPasswordInput.classList.remove('border-red-500');
        }

        /**
         * 显示/隐藏加载状态
         */
        function showLoadingState(isLoading) {
            if (isLoading) {
                createAccountBtn.disabled = true;
                btnText.classList.add('hidden');
                btnLoading.classList.remove('hidden');
            } else {
                // 恢复按钮状态
                validatePassword();
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
            }
        }

        /**
         * 显示Toast提示
         */
        function showToast(message, isSuccess = false) {
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center toast-notification transition-all duration-300`;

            if (isSuccess) {
                toast.classList.add('bg-green-500', 'text-white');
                toast.innerHTML = `<i class="fa fa-check-circle mr-2"></i>${message}`;
            } else {
                toast.classList.add('bg-primary-red', 'text-white');
                toast.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i>${message}`;
            }

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, -20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 添加抖动动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                20%, 40%, 60%, 80% { transform: translateX(5px); }
            }
            .animate-shake {
                animation: shake 0.5s ease-in-out;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>